import os
import json
import requests
import streamlit as st
from typing import Dict, Any, List, Optional

# ---------------------
# Config
# ---------------------
# Force 8004 by default; allow env override if you set BACKEND_BASE_URL externally.
BACKEND_BASE_URL = os.getenv("BACKEND_BASE_URL", "http://localhost:8004")

st.set_page_config(page_title="SAP OData Chatbot", page_icon="ü§ñ", layout="wide")

# ---------------------
# Custom CSS for chat bubbles
# ---------------------
CHAT_CSS = """
<style>
.chat-container { max-width: 1100px; margin: 0 auto; }
.bubble-row { display: flex; margin: 8px 0; }
.bubble { padding: 12px 14px; border-radius: 16px; max-width: 75%; font-size: 15px; line-height: 1.45; }
.bubble.user { background: #DCF2FF; color: #0D1B2A; margin-left: auto; border-bottom-right-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
.bubble.bot { background: #FFFFFF; color: #0D1B2A; margin-right: auto; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.08); border: 1px solid #EEF0F3; }
.header { font-weight: 600; margin-bottom: 6px; color: #0D1B2A; }
.preview-card { background: #FAFCFF; border: 1px solid #E7EEF8; border-radius: 12px; padding: 12px; margin: 6px 0; font-size: 13px;}
.badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #E9F5EC; color: #22663B; font-size: 12px; margin-right: 6px;}
hr.sep { border: none; border-top: 1px solid #EEF0F3; margin: 12px 0; }
small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color: #415A77;}
.sidebar-note { font-size: 12px; color: #415A77; }
h1.title { font-size: 28px; margin: 0 0 8px 0; }
.subtitle { color: #5C6B7A; margin-bottom: 12px; }
</style>
"""
st.markdown(CHAT_CSS, unsafe_allow_html=True)

# ---------------------
# Helpers to call backend
# ---------------------
def fetch_registry() -> Dict[str, Any]:
    try:
        r = requests.get(f"{BACKEND_BASE_URL}/api/odata/registry", timeout=20)
        r.raise_for_status()
        return r.json()
    except Exception:
        return {"services": {}}

def chat_api(message: str, preview_only: bool = True, confirm: bool = False, allowed_services: Optional[List[str]] = None) -> Dict[str, Any]:
    payload = {"message": message, "preview_only": preview_only, "confirm": confirm}
    if allowed_services:
        payload["allowed_services"] = allowed_services
    r = requests.post(f"{BACKEND_BASE_URL}/api/chat", json=payload, timeout=90)
    r.raise_for_status()
    return r.json()

def chat_api_general(message: str) -> Dict[str, Any]:
    payload = {"message": message, "preview_only": True, "confirm": False}
    r = requests.post(f"{BACKEND_BASE_URL}/api/chat/general", json=payload, timeout=90)
    r.raise_for_status()
    return r.json()

def odata_get(service: str, entity: str, fields: Optional[List[str]], filters: Optional[List[Dict[str, Any]]]):
    body = {"service": service, "entity": entity, "fields": fields, "filters": filters}
    r = requests.post(f"{BACKEND_BASE_URL}/api/odata/get", json=body, timeout=90)
    r.raise_for_status()
    return r.json()

def odata_post_preview(action: str, service: str, entity: str, key_fields: Optional[Dict[str, Any]], payload: Dict[str, Any]):
    body = {"action": action, "service": service, "entity": entity, "key_fields": key_fields, "payload": payload, "confirm": False}
    r = requests.post(f"{BACKEND_BASE_URL}/api/odata/post/preview", json=body, timeout=90)
    r.raise_for_status()
    return r.json()

def odata_post_confirm(action: str, service: str, entity: str, key_fields: Optional[Dict[str, Any]], payload: Dict[str, Any]):
    body = {"action": action, "service": service, "entity": entity, "key_fields": key_fields, "payload": payload, "confirm": True}
    r = requests.post(f"{BACKEND_BASE_URL}/api/odata/post/confirm", json=body, timeout=90)
    r.raise_for_status()
    return r.json()

# ---------------------
# State
# ---------------------
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "bot", "text": "Hello üëã, I‚Äôm here to help with SAP plant address changes and other OData tasks. How can I help today?"}
    ]

if "registry" not in st.session_state:
    st.session_state.registry = fetch_registry()

if "nlp_mode" not in st.session_state:
    st.session_state.nlp_mode = True

if "pending_preview" not in st.session_state:
    st.session_state.pending_preview = None  # {action,service,entity,key_fields,payload}

# ---------------------
# Sidebar (Guided controls) ‚Äî no backend URL input anymore
# ---------------------
with st.sidebar:
    st.markdown("### ‚öôÔ∏è Settings")
    st.markdown(f"<small class='mono'>Backend: {BACKEND_BASE_URL}</small>", unsafe_allow_html=True)

    colA, colB = st.columns([1,1])
    with colA:
        if st.button("Reload registry"):
            st.session_state.registry = fetch_registry()
    with colB:
        st.session_state.nlp_mode = st.toggle(
            "NLP mode",
            value=st.session_state.nlp_mode,
            help="When on, messages go to /api/chat to detect intent; UI calls OData endpoints."
        )

    st.markdown("<hr class='sep'/>", unsafe_allow_html=True)
    st.markdown("### üß© Guided Mode (reads registry)")
    services = st.session_state.registry.get("services", {})
    svc_names = sorted(list(services.keys()))
    sel_service = st.selectbox("Service", options=svc_names, index=0) if svc_names else None

    sel_entity = None
    fields_for_entity: List[str] = []
    key_fields_for_entity: List[str] = []
    if sel_service:
        ents = services[sel_service].get("entities", {})
        ent_names = sorted(list(ents.keys()))
        sel_entity = st.selectbox("Entity", options=ent_names, index=0) if ent_names else None
        if sel_entity:
            fields_for_entity = ents[sel_entity].get("fields", [])
            key_fields_for_entity = ents[sel_entity].get("key_fields", [])

    st.markdown("<div class='sidebar-note'>When NLP mode is OFF, you can guide updates using these picks.</div>", unsafe_allow_html=True)

# ---------------------
# Chat header
# ---------------------
st.markdown("<div class='chat-container'>", unsafe_allow_html=True)
st.markdown("<h1 class='title'>SAP OData Chatbot</h1>", unsafe_allow_html=True)
st.markdown("<div class='subtitle'>Auto-detects general chat or OData (GET / create / update). No raw JSON shown.</div>", unsafe_allow_html=True)

# ---------------------
# Render messages
# ---------------------
for msg in st.session_state.messages:
    cls = "user" if msg["role"] == "user" else "bot"
    st.markdown(f"<div class='bubble-row'><div class='bubble {cls}'>{msg['text']}</div></div>", unsafe_allow_html=True)

# ---------------------
# Input form
# ---------------------
with st.form("chat-input", clear_on_submit=True):
    user_text = st.text_input("Type a message", placeholder="Hi! I want to update plant address of plant Z125...")
    submitted = st.form_submit_button("Send")

# ---------------------
# Bot logic
# ---------------------
def add_bot(text: str):
    st.session_state.messages.append({"role": "bot", "text": text})

def add_user(text: str):
    st.session_state.messages.append({"role": "user", "text": text})

def friendly_error(details: Optional[str] = None):
    add_bot("Sorry, I couldn‚Äôt complete that request. Please rephrase or try again.")
    if details:
        st.caption(f"Details: {details}")

# Utility to summarize GET results without dumping JSON
def summarize_get_result(payload: Dict[str, Any]) -> str:
    # Expecting your backend wrapper: {"ok":..., "data": ...}
    data = payload.get("data")
    if isinstance(data, dict):
        # OData payloads often have "d": {"results": [...] } or "value": [...]
        if "d" in data and isinstance(data["d"], dict) and "results" in data["d"]:
            count = len(data["d"]["results"])
            return f"Fetched {count} record(s)."
        if "value" in data and isinstance(data["value"], list):
            count = len(data["value"])
            return f"Fetched {count} record(s)."
        return "Fetched data successfully."
    if isinstance(data, list):
        return f"Fetched {len(data)} record(s)."
    return "Fetched data successfully."

if submitted and user_text.strip():
    user_msg = user_text.strip()
    add_user(user_msg)

    lower = user_msg.lower()

    # If we have a pending preview and user says Yes/Confirm ‚Üí execute
    if st.session_state.pending_preview and any(k in lower for k in ["yes", "confirm", "proceed", "go ahead", "do the changes", "yes do the changes"]):
        prev = st.session_state.pending_preview
        try:
            _ = odata_post_confirm(prev["action"], prev["service"], prev["entity"], prev["key_fields"], prev["payload"])
            add_bot("‚úÖ Changes executed successfully.")
            st.session_state.pending_preview = None
        except Exception as e:
            friendly_error(str(e))
        st.rerun()

    # Normal flow: NLP-only to detect; UI calls OData endpoints; general uses /chat/general
    try:
        if st.session_state.nlp_mode:
            nlp_resp = chat_api(user_msg, preview_only=True, confirm=False)
            stage = nlp_resp.get("stage")
            nlp = nlp_resp.get("nlp_json") or {}

            if stage == "general":
                g = chat_api_general(user_msg)
                add_bot(g.get("result", {}).get("text", "üí¨ (no response)"))
                st.rerun()

            elif (nlp.get("intent") == "get") or (stage == "get"):
                try:
                    get_resp = odata_get(
                        service=nlp.get("service"),
                        entity=nlp.get("entity"),
                        fields=nlp.get("fields"),
                        filters=nlp.get("filters"),
                    )
                    add_bot("üîé " + summarize_get_result(get_resp))
                except Exception as e:
                    friendly_error(str(e))
                st.rerun()

            elif nlp.get("intent") in ("create", "update") or (stage == "preview"):
                try:
                    action = "create" if nlp.get("intent") == "create" else "update"
                    service = nlp.get("service")
                    entity = nlp.get("entity")
                    key_fields = nlp.get("key_fields")
                    payload = nlp.get("payload") or {}

                    _ = odata_post_preview(
                        action=action, service=service, entity=entity,
                        key_fields=key_fields, payload=payload
                    )
                    st.session_state.pending_preview = {
                        "action": action,
                        "service": service,
                        "entity": entity,
                        "key_fields": key_fields,
                        "payload": payload,
                    }
                    add_bot("üìù Preview ready. Say **Yes** to confirm, or provide more fields/values.")
                except Exception as e:
                    friendly_error(str(e))
                st.rerun()

            else:
                add_bot("How can I help you further?")
                st.rerun()

        else:
            # Guided mode without NLP
            if not (sel_service and sel_entity):
                add_bot("Please select a Service and Entity from the sidebar first.")
                st.rerun()
            else:
                add_bot(f"Working with **{sel_service} ‚Üí {sel_entity}**. Provide values as `field=value`.")
                payload: Dict[str, Any] = {}
                for part in user_msg.replace(",", " ").split():
                    if "=" in part:
                        k, v = part.split("=", 1)
                        payload[k.strip()] = v.strip()
                if not payload:
                    add_bot("Example: `Telephone=+91-1234567, Extension=100`.")
                else:
                    try:
                        _ = odata_post_preview("update", sel_service, sel_entity, None, payload)
                        st.session_state.pending_preview = {
                            "action": "update",
                            "service": sel_service,
                            "entity": sel_entity,
                            "key_fields": None,
                            "payload": payload
                        }
                        add_bot("üìù Preview ready. Say **Yes** to confirm.")
                    except Exception as e:
                        friendly_error(str(e))
                st.rerun()

    except Exception as e:
        friendly_error(str(e))
        st.rerun()

st.markdown("</div>", unsafe_allow_html=True)
