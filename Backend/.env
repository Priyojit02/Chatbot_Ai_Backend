import os
import json
import requests
import streamlit as st
from typing import Dict, Any, List, Optional

# ---------------------
# Config
# ---------------------
BACKEND_BASE_URL = os.getenv("BACKEND_BASE_URL", "http://localhost:8004")

st.set_page_config(page_title="SAP AI Robo Helper ü§ñ", page_icon="ü§ñ", layout="wide")

# ---------------------
# Custom CSS for chat bubbles
# ---------------------
CHAT_CSS = """
<style>
.chat-container { max-width: 1100px; margin: 0 auto; }
.bubble-row { display: flex; margin: 8px 0; }
.bubble { padding: 12px 14px; border-radius: 16px; max-width: 75%; font-size: 15px; line-height: 1.45; }
.bubble.user { background: #DCF2FF; color: #0D1B2A; margin-left: auto; border-bottom-right-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.06); }
.bubble.bot { background: #FFFFFF; color: #0D1B2A; margin-right: auto; border-bottom-left-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.08); border: 1px solid #EEF0F3; }
.header { font-weight: 600; margin-bottom: 6px; color: #0D1B2A; }
.preview-card { background: #FAFCFF; border: 1px solid #E7EEF8; border-radius: 12px; padding: 12px; margin: 6px 0; font-size: 13px;}
.badge { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #E9F5EC; color: #22663B; font-size: 12px; margin-right: 6px;}
hr.sep { border: none; border-top: 1px solid #EEF0F3; margin: 12px 0; }
small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color: #415A77;}
.sidebar-note { font-size: 12px; color: #415A77; }
h1.title { font-size: 28px; margin: 0 0 8px 0; }
.subtitle { color: #5C6B7A; margin-bottom: 12px; }
</style>
"""
st.markdown(CHAT_CSS, unsafe_allow_html=True)

# ---------------------
# Backend helpers
# ---------------------
def fetch_registry() -> Dict[str, Any]:
    try:
        r = requests.get(f"{BACKEND_BASE_URL}/api/odata/registry", timeout=20)
        r.raise_for_status()
        return r.json()
    except Exception:
        return {"services": {}}

def chat_api(message: str, preview_only: bool = True, confirm: bool = False, allowed_services: Optional[List[str]] = None) -> Dict[str, Any]:
    payload = {"message": message, "preview_only": preview_only, "confirm": confirm}
    if allowed_services:
        payload["allowed_services"] = allowed_services
    r = requests.post(f"{BACKEND_BASE_URL}/api/chat", json=payload, timeout=90)
    r.raise_for_status()
    return r.json()

def chat_api_general(message: str) -> Dict[str, Any]:
    payload = {"message": message, "preview_only": True, "confirm": False}
    r = requests.post(f"{BACKEND_BASE_URL}/api/chat/general", json=payload, timeout=90)
    r.raise_for_status()
    return r.json()

def odata_get(service: str, entity: str, fields: Optional[List[str]], filters: Optional[List[Dict[str, Any]]]):
    body = {"service": service, "entity": entity, "fields": fields, "filters": filters}
    r = requests.post(f"{BACKEND_BASE_URL}/api/odata/get", json=body, timeout=90)
    r.raise_for_status()
    return r.json()

def odata_post_preview(action: str, service: str, entity: str, key_fields: Optional[Dict[str, Any]], payload: Dict[str, Any]):
    body = {"action": action, "service": service, "entity": entity, "key_fields": key_fields, "payload": payload, "confirm": False}
    r = requests.post(f"{BACKEND_BASE_URL}/api/odata/post/preview", json=body, timeout=90)
    r.raise_for_status()
    return r.json()

def odata_post_confirm(action: str, service: str, entity: str, key_fields: Optional[Dict[str, Any]], payload: Dict[str, Any]):
    body = {"action": action, "service": service, "entity": entity, "key_fields": key_fields, "payload": payload, "confirm": True}
    r = requests.post(f"{BACKEND_BASE_URL}/api/odata/post/confirm", json=body, timeout=90)
    r.raise_for_status()
    return r.json()

# ---------------------
# State
# ---------------------
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "bot", "text": "ü§ñ Hello! I‚Äôm your **SAP AI Robo Helper** ‚Äî ready to handle OData tasks, plant address updates, and general queries!"}
    ]

if "registry" not in st.session_state:
    st.session_state.registry = fetch_registry()

if "nlp_mode" not in st.session_state:
    st.session_state.nlp_mode = True

if "pending_preview" not in st.session_state:
    st.session_state.pending_preview = None

# ---------------------
# Sidebar
# ---------------------
with st.sidebar:
    st.markdown("### ‚öôÔ∏è Settings")
    st.markdown(f"<small class='mono'>Backend connected: {BACKEND_BASE_URL}</small>", unsafe_allow_html=True)

    colA, colB = st.columns([1,1])
    with colA:
        if st.button("Reload Registry"):
            st.session_state.registry = fetch_registry()
    with colB:
        st.session_state.nlp_mode = st.toggle(
            "AI Mode",
            value=st.session_state.nlp_mode,
            help="When ON, messages are auto-detected (OData or General)."
        )

    st.markdown("<hr class='sep'/>", unsafe_allow_html=True)
    st.markdown("### üß© Guided Mode (registry-aware)")
    services = st.session_state.registry.get("services", {})
    svc_names = sorted(list(services.keys()))
    sel_service = st.selectbox("Service", options=svc_names, index=0) if svc_names else None

    sel_entity = None
    fields_for_entity: List[str] = []
    key_fields_for_entity: List[str] = []
    if sel_service:
        ents = services[sel_service].get("entities", {})
        ent_names = sorted(list(ents.keys()))
        sel_entity = st.selectbox("Entity", options=ent_names, index=0) if ent_names else None
        if sel_entity:
            fields_for_entity = ents[sel_entity].get("fields", [])
            key_fields_for_entity = ents[sel_entity].get("key_fields", [])

    st.markdown("<div class='sidebar-note'>Guided Mode helps collect fields manually when AI mode is off.</div>", unsafe_allow_html=True)

# ---------------------
# Header
# ---------------------
st.markdown("<div class='chat-container'>", unsafe_allow_html=True)
st.markdown("<h1 class='title'>SAP AI Robo Helper ü§ñ</h1>", unsafe_allow_html=True)
st.markdown("<div class='subtitle'>Smart assistant for SAP OData, plant address updates, and general queries ‚Äî all in one place.</div>", unsafe_allow_html=True)

# ---------------------
# Message display
# ---------------------
for msg in st.session_state.messages:
    cls = "user" if msg["role"] == "user" else "bot"
    st.markdown(f"<div class='bubble-row'><div class='bubble {cls}'>{msg['text']}</div></div>", unsafe_allow_html=True)

# ---------------------
# Input
# ---------------------
with st.form("chat-input", clear_on_submit=True):
    user_text = st.text_input("Ask me anything or give an SAP command...")
    submitted = st.form_submit_button("Send")

# ---------------------
# Chat logic
# ---------------------
def add_bot(text: str):
    st.session_state.messages.append({"role": "bot", "text": text})

def add_user(text: str):
    st.session_state.messages.append({"role": "user", "text": text})

def friendly_error(details: Optional[str] = None):
    add_bot("‚ö†Ô∏è Sorry, I couldn‚Äôt complete that. Try rephrasing.")
    if details:
        st.caption(f"Details: {details}")

def summarize_get_result(payload: Dict[str, Any]) -> str:
    data = payload.get("data")
    if isinstance(data, dict):
        if "value" in data and isinstance(data["value"], list):
            return f"‚úÖ Retrieved {len(data['value'])} record(s)."
        if "d" in data and isinstance(data["d"], dict) and "results" in data["d"]:
            return f"‚úÖ Retrieved {len(data['d']['results'])} record(s)."
    return "‚úÖ Data fetched successfully."

if submitted and user_text.strip():
    user_msg = user_text.strip()
    add_user(user_msg)
    lower = user_msg.lower()

    try:
        # If preview waiting and user confirms
        if st.session_state.pending_preview and any(k in lower for k in ["yes", "confirm", "proceed", "go ahead", "do the changes"]):
            prev = st.session_state.pending_preview
            _ = odata_post_confirm(prev["action"], prev["service"], prev["entity"], prev["key_fields"], prev["payload"])
            add_bot("‚úÖ Changes executed successfully.")
            st.session_state.pending_preview = None
            st.rerun()

        # Main AI flow
        if st.session_state.nlp_mode:
            resp = chat_api(user_msg)
            stage = resp.get("stage", "")
            nlp = resp.get("nlp_json") or {}

            if stage == "general":
                g = chat_api_general(user_msg)
                add_bot(g.get("result", {}).get("text", "üí¨ (no response)"))
                st.rerun()

            elif stage == "get" or nlp.get("intent") == "get":
                get_data = odata_get(nlp.get("service"), nlp.get("entity"), nlp.get("fields"), nlp.get("filters"))
                add_bot(summarize_get_result(get_data))
                st.rerun()

            elif nlp.get("intent") in ("create", "update") or stage == "preview":
                prev = odata_post_preview(
                    action=nlp.get("intent"),
                    service=nlp.get("service"),
                    entity=nlp.get("entity"),
                    key_fields=nlp.get("key_fields"),
                    payload=nlp.get("payload") or {},
                )
                st.session_state.pending_preview = {
                    "action": nlp.get("intent"),
                    "service": nlp.get("service"),
                    "entity": nlp.get("entity"),
                    "key_fields": nlp.get("key_fields"),
                    "payload": nlp.get("payload") or {},
                }
                add_bot("üìù Preview ready. Say **Yes** to confirm or adjust fields.")
                st.rerun()

            else:
                add_bot("How can I assist you further?")
                st.rerun()

        else:
            # Guided mode (manual)
            if not (sel_service and sel_entity):
                add_bot("Please pick a Service and Entity first.")
            else:
                add_bot(f"Working with {sel_service} ‚Üí {sel_entity}. Provide field=value pairs.")
                payload: Dict[str, Any] = {}
                for part in user_msg.replace(",", " ").split():
                    if "=" in part:
                        k, v = part.split("=", 1)
                        payload[k.strip()] = v.strip()
                if not payload:
                    add_bot("Example: `Telephone=+91-1234567, Extension=100`.")
                else:
                    _ = odata_post_preview("update", sel_service, sel_entity, None, payload)
                    st.session_state.pending_preview = {
                        "action": "update",
                        "service": sel_service,
                        "entity": sel_entity,
                        "key_fields": None,
                        "payload": payload,
                    }
                    add_bot("üìù Preview ready. Say **Yes** to confirm.")
                st.rerun()

    except Exception as e:
        friendly_error(str(e))
        st.rerun()

st.markdown("</div>", unsafe_allow_html=True)
